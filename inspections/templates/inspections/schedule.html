<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Generate Inspection Schedule</title>
  <style>
    :root {
      --wsp-red: #ef3427;
      --wsp-dark: #313131;
      --wsp-red-dark: #c9271b;
      --wsp-border: #d4d4d4;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; color: var(--wsp-dark); }
    header {
      background: #000;
      border-top: 4px solid var(--wsp-red);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    header .logo-mark {
      width: 10px;
      height: 32px;
      background: var(--wsp-red);
      flex-shrink: 0;
    }
    header h1 {
      color: #fff;
      font-size: 1rem;
      font-weight: bold;
      margin: 0;
      letter-spacing: 0.03em;
    }
    header h1 span.accent { color: var(--wsp-red); }
    .page-body { padding: 1.5rem; max-width: 1400px; }
    h2 { font-size: 1.1rem; margin: 0 0 0.2rem; color: var(--wsp-dark); }
    p.hint { color: #666; font-size: 0.875rem; margin: 0 0 1rem; }
    .field { margin-bottom: 0.75rem; }
    .field label { display: block; font-size: 0.875rem; font-weight: bold; margin-bottom: 0.25rem; color: var(--wsp-dark); }
    select { padding: 0.3rem 0.5rem; font-size: 0.9rem; border: 1px solid var(--wsp-border); }
    select:focus { outline: 2px solid var(--wsp-red); }
    textarea {
      width: 100%;
      height: 180px;
      font-family: monospace;
      font-size: 11px;
      padding: 0.5rem;
      border: 1px solid var(--wsp-border);
    }
    textarea:focus { outline: 2px solid var(--wsp-red); }
    button {
      margin-top: 0.5rem;
      margin-right: 0.5rem;
      padding: 0.4rem 1.2rem;
      font-size: 0.9rem;
      cursor: pointer;
      border: 1px solid var(--wsp-border);
      background: #fff;
      color: var(--wsp-dark);
    }
    button:hover { background: #f0f0f0; }
    button.primary { background: var(--wsp-red); color: #fff; border: none; }
    button.primary:hover { background: var(--wsp-red-dark); }
    .count { margin-top: 1rem; font-size: 0.875rem; color: #444; }
    table { border-collapse: collapse; width: 100%; margin-top: 0.5rem; font-size: 11px; }
    th, td { border: 1px solid var(--wsp-border); padding: 3px 6px; text-align: left; white-space: nowrap; }
    th { background: var(--wsp-dark); color: #fff; font-size: 11px; }
    tr:nth-child(even) { background: #f7f7f7; }
    td.lc-y { color: var(--wsp-red); font-weight: bold; }
    td[contenteditable]:focus { outline: 2px solid var(--wsp-red); background: #fff; }
    details.settings { margin-bottom: 0.75rem; border: 1px solid var(--wsp-border); border-radius: 3px; padding: 0.4rem 0.75rem; background: #fff; }
    details.settings summary { cursor: pointer; font-size: 0.875rem; font-weight: bold; user-select: none; color: var(--wsp-dark); }
    .settings-field { margin-top: 0.5rem; margin-bottom: 0; }
    .settings-field input[type="text"] { width: 100%; padding: 0.3rem 0.5rem; font-size: 0.875rem; font-family: monospace; border: 1px solid var(--wsp-border); }
    .settings-field input[type="text"]:focus { outline: 2px solid var(--wsp-red); }
    .hint-inline { font-size: 0.8rem; color: #777; display: block; margin-top: 0.2rem; }
  </style>
</head>
<body>
  <header>
    <div class="logo-mark"></div>
    <h1><span class="accent">WSP USA</span> &mdash; NYSDOT Region 8 Bridge Inspection</h1>
  </header>
  <div class="page-body">
  <h2>Generate Inspection Schedule</h2>
  <p class="hint">
    Select your team, then copy rows from the master spreadsheet and paste below.
    Columns used: Cty, BIN, Carried, Crossed, Due Date, Access, Booked Access, TOWN.
  </p>

  <form method="post" id="main-form">
    {% csrf_token %}
    <div class="field">
      <label for="team_name">Team</label>
      <select id="team_name" name="team_name" required>
        <option value="" disabled {% if not selected_team %}selected{% endif %}>-- Select team leader --</option>
        {% for last_name, full_name in team_choices %}
        <option value="{{ last_name }}" {% if selected_team == last_name %}selected{% endif %}>{{ full_name }}</option>
        {% endfor %}
      </select>
    </div>
    <details {% if output_dir %}open{% endif %} class="settings">
      <summary>Settings</summary>
      <div class="field settings-field">
        <label for="output_dir">Output directory</label>
        <input
          type="text"
          id="output_dir"
          name="output_dir"
          value="{{ output_dir }}"
          placeholder="Leave blank to use default output/ folder"
          spellcheck="false"
        >
        <span class="hint-inline">Full path on the host machine, e.g. /home/user/schedules</span>
      </div>
    </details>
    <div class="field">
      <label for="raw_tsv">Paste data</label>
      <textarea id="raw_tsv" name="raw_tsv" placeholder="Paste tab-separated rows here...">{{ raw_tsv }}</textarea>
    </div>
    <input type="hidden" id="entries_json" name="entries_json" value="">
    <button type="submit" name="action" value="preview">Preview</button>
    <button type="submit" name="action" value="generate" class="primary" id="btn-generate">Generate Schedules</button>
  </form>

  <script>
    function serializeTable() {
      var rows = document.querySelectorAll("table tbody tr");
      if (!rows.length) return "";
      var entries = [];
      rows.forEach(function (row) {
        var cells = row.querySelectorAll("td");
        entries.push({
          bin:              cells[0].innerText.trim(),
          county:           cells[1].innerText.trim(),
          feature_carried:  cells[2].innerText.trim(),
          feature_crossed:  cells[3].innerText.trim(),
          due_date:         cells[4].innerText.trim(),
          scheduled_date:   cells[5].innerText.trim(),
          access:           cells[6].innerText.trim(),
          lane_closed:      cells[7].innerText.trim(),
          town:             cells[8].innerText.trim()
        });
      });
      return JSON.stringify(entries);
    }

    document.getElementById("btn-generate").addEventListener("click", function (e) {
      var team = document.getElementById("team_name").value;
      if (!team) return; // browser required validation will handle this
      var dirInput = document.getElementById("output_dir");
      var dir = prompt(
        "Save to directory (leave blank to download to browser):",
        dirInput.value.trim()
      );
      if (dir === null) {
        e.preventDefault();
        return;
      }
      dirInput.value = dir.trim();
      document.getElementById("entries_json").value = serializeTable();
    });
  </script>

  {% if entry_count %}
  <p class="count">{{ entry_count }} row{{ entry_count|pluralize }} parsed.</p>
  <table>
    <thead>
      <tr>
        <th>BIN</th>
        <th>County</th>
        <th>Feature Carried</th>
        <th>Feature Crossed</th>
        <th>Due Date</th>
        <th>Scheduled Date</th>
        <th>Access</th>
        <th>Lane Closed</th>
        <th>Town</th>
      </tr>
    </thead>
    <tbody>
      {% for e in entries %}
      <tr>
        <td contenteditable="true" spellcheck="false">{{ e.bin }}</td>
        <td contenteditable="true" spellcheck="false">{{ e.county }}</td>
        <td contenteditable="true" spellcheck="false">{{ e.feature_carried }}</td>
        <td contenteditable="true" spellcheck="false">{{ e.feature_crossed }}</td>
        <td contenteditable="true" spellcheck="false">{% if e.due_date %}{{ e.due_date|date:"m/d/Y" }}{% else %}-{% endif %}</td>
        <td contenteditable="true" spellcheck="false">{{ e.scheduled_date|date:"m/d/Y" }}</td>
        <td contenteditable="true" spellcheck="false">{{ e.access }}</td>
        <td contenteditable="true" spellcheck="false" {% if e.lane_closed == "Y" %}class="lc-y"{% endif %}>{{ e.lane_closed }}</td>
        <td contenteditable="true" spellcheck="false">{{ e.town }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% elif request.method == "POST" %}
  <p class="count">No valid rows found. Make sure the pasted data includes BIN and Booked Access columns.</p>
  {% endif %}
  </div>
</body>
</html>
